name: ğŸ”— Shadowsocks Tester - Manual Execution

on:
  # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Ø­Ø§Ù„Øª ØªØ³Øª'
        required: true
        default: 'single'
        type: choice
        options:
          - single
          - auto
      max_configs:
        description: 'Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ ØªØ³Øª Ø´Ø¯Ù‡'
        required: false
        default: '10000'
        type: string
      batch_size:
        description: 'Ø§Ù†Ø¯Ø§Ø²Ù‡ batch Ø¨Ø±Ø§ÛŒ ØªØ³Øª'
        required: false
        default: '50'
        type: string
      force_update:
        description: 'Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø¬Ø¨Ø§Ø±ÛŒ'
        required: false
        default: false
        type: boolean
      test_specific_protocols:
        description: 'Ù¾Ø±ÙˆØªÚ©Ù„â€ŒÙ‡Ø§ÛŒ Ø®Ø§Øµ Ø¨Ø±Ø§ÛŒ ØªØ³Øª'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - ss_only
          - ss_with_xray
      log_level:
        description: 'Ø³Ø·Ø­ Ù„Ø§Ú¯'
        required: false
        default: 'INFO'
        type: choice
        options:
          - DEBUG
          - INFO
          - WARNING
          - ERROR

env:
  PYTHON_VERSION: '3.9'
  WORKING_DIRECTORY: './'

jobs:
  test-shadowsocks-manual:
    name: ğŸ§ª ØªØ³Øª Ø¯Ø³ØªÛŒ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Shadowsocks
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“‹ Display test parameters
        run: |
          echo "ğŸ” Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ ØªØ³Øª:"
          echo "  ğŸ“Š Ø­Ø§Ù„Øª ØªØ³Øª: ${{ github.event.inputs.test_mode }}"
          echo "  ğŸ”¢ Ø­Ø¯Ø§Ú©Ø«Ø± Ú©Ø§Ù†ÙÛŒÚ¯: ${{ github.event.inputs.max_configs }}"
          echo "  ğŸ“¦ Ø§Ù†Ø¯Ø§Ø²Ù‡ batch: ${{ github.event.inputs.batch_size }}"
          echo "  ğŸ”„ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø¬Ø¨Ø§Ø±ÛŒ: ${{ github.event.inputs.force_update }}"
          echo "  ğŸ”— Ù¾Ø±ÙˆØªÚ©Ù„â€ŒÙ‡Ø§ÛŒ ØªØ³Øª: ${{ github.event.inputs.test_specific_protocols }}"
          echo "  ğŸ“ Ø³Ø·Ø­ Ù„Ø§Ú¯: ${{ github.event.inputs.log_level }}"
          echo "  ğŸ Ù†Ø³Ø®Ù‡ Python: ${{ env.PYTHON_VERSION }}"
          echo "  ğŸš€ Triggered by: ${{ github.event_name }}"
          echo "  ğŸ‘¤ User: ${{ github.actor }}"
      
      - name: ğŸ”§ Install dependencies
        run: |
          cd ss
          echo "ğŸ“¦ Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§..."
          pip install -r requirements.txt
          echo "âœ… ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ Ù†ØµØ¨ Ø´Ø¯Ù†Ø¯"
          echo "ğŸ“‹ Ù„ÛŒØ³Øª Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ÛŒ Ù†ØµØ¨ Ø´Ø¯Ù‡:"
          pip list
      
      - name: ğŸ“ Environment validation
        run: |
          echo "ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­ÛŒØ· Ø§Ø¬Ø±Ø§..."
          echo "ğŸ“ Ù…Ø³ÛŒØ± ÙØ¹Ù„ÛŒ: $(pwd)"
          echo "ğŸ“ Ù…Ø­ØªÙˆÛŒØ§Øª Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ ss:"
          ls -la ss/
          
          echo "ğŸ“ Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Xray:"
          if [ -d "Files/xray-bin" ]; then
            ls -la Files/xray-bin/
            echo "âœ… Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ Xray Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª"
          else
            echo "âŒ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ Files/xray-bin ÛŒØ§ÙØª Ù†Ø´Ø¯"
          fi
          
          echo "ğŸ“ Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ø¨Ø¹:"
          if [ -d "configs/raw" ]; then
            ls -la configs/raw/
            echo "âœ… Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ Ù…Ù†Ø¨Ø¹ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª"
          else
            echo "âŒ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ configs/raw ÛŒØ§ÙØª Ù†Ø´Ø¯"
          fi
          
          echo "ğŸ“ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ:"
          mkdir -p trustlink logs
          echo "âœ… Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù†Ø¯"
      
      - name: ğŸš€ Run Shadowsocks Tester
        run: |
          cd ss
          echo "ğŸš€ Ø´Ø±ÙˆØ¹ ØªØ³Øª Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Shadowsocks..."
          
          # ØªÙ†Ø¸ÛŒÙ… Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ
          export MAX_CONFIGS_TO_TEST="${{ github.event.inputs.max_configs }}"
          export BATCH_SIZE="${{ github.event.inputs.batch_size }}"
          export LOG_LEVEL="${{ github.event.inputs.log_level }}"
          
          echo "ğŸ”§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯:"
          echo "  MAX_CONFIGS_TO_TEST: $MAX_CONFIGS_TO_TEST"
          echo "  BATCH_SIZE: $BATCH_SIZE"
          echo "  LOG_LEVEL: $LOG_LEVEL"
          
          # Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª
          if [ "${{ github.event.inputs.test_mode }}" = "auto" ]; then
            echo "ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Ø®ÙˆØ¯Ú©Ø§Ø±..."
            timeout 3600 python ss_tester.py --auto || echo "â° timeout Ø¨Ø¹Ø¯ Ø§Ø² 1 Ø³Ø§Ø¹Øª"
          else
            echo "ğŸ“Š Ø§Ø¬Ø±Ø§ÛŒ Ø­Ø§Ù„Øª ÛŒÚ©Ø¨Ø§Ø±Ù‡..."
            python ss_tester.py
          fi
          
          echo "âœ… ØªØ³Øª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯"
      
      - name: ğŸ“Š Analyze results
        run: |
          echo "ğŸ“Š ØªØ­Ù„ÛŒÙ„ Ù†ØªØ§ÛŒØ¬ ØªØ³Øª..."
          
          # Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ
          if [ -f "trustlink/trustlink_ss.txt" ]; then
            echo "âœ… ÙØ§ÛŒÙ„ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ù„Ù… Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯"
            total_lines=$(wc -l < trustlink/trustlink_ss.txt)
            echo "ğŸ“ ØªØ¹Ø¯Ø§Ø¯ Ø®Ø·ÙˆØ·: $total_lines"
            
            # Ø´Ù…Ø§Ø±Ø´ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ (Ø¨Ø¯ÙˆÙ† Ú©Ø§Ù…Ù†Øª)
            actual_configs=$(grep -c "^ss://" trustlink/trustlink_ss.txt || echo "0")
            echo "ğŸ”— Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ: $actual_configs"
          else
            echo "âŒ ÙØ§ÛŒÙ„ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ù„Ù… ÛŒØ§ÙØª Ù†Ø´Ø¯"
          fi
          
          if [ -f "trustlink/.trustlink_ss_metadata.json" ]; then
            echo "âœ… ÙØ§ÛŒÙ„ Ù…ØªØ§Ø¯ÛŒØªØ§ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯"
            echo "ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ù…ØªØ§Ø¯ÛŒØªØ§:"
            python -c "import json; data=json.load(open('trustlink/.trustlink_ss_metadata.json')); print(f'Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: {data.get(\"last_update\", \"Ù†Ø§Ù…Ø´Ø®Øµ\")}'); print(f'Ú©Ù„ ØªØ³Øªâ€ŒÙ‡Ø§: {data.get(\"total_tests\", 0)}'); print(f'Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ù„Ù…: {data.get(\"working_configs\", 0)}'); print(f'Ú©Ù„ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§: {data.get(\"total_configs\", 0)}'); stats=data.get('test_statistics', {}); print(f'Ø§ØªØµØ§Ù„ Ø³Ø§Ù„Ù…: {stats.get(\"connection_ok\", 0)}'); print(f'Ø¯Ø³ØªØ±Ø³ÛŒ Ø§ÛŒØ±Ø§Ù†: {stats.get(\"iran_access_ok\", 0)}'); print(f'Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ: {stats.get(\"social_media_ok\", 0)}'); print(f'Ø³Ø±Ø¹Øª Ø¯Ø§Ù†Ù„ÙˆØ¯: {stats.get(\"download_speed_ok\", 0)}')" 2>/dev/null || echo "âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ù…ØªØ§Ø¯ÛŒØªØ§"
          else
            echo "âŒ ÙØ§ÛŒÙ„ Ù…ØªØ§Ø¯ÛŒØªØ§ ÛŒØ§ÙØª Ù†Ø´Ø¯"
          fi
          
          if [ -f "logs/ss_tester.log" ]; then
            echo "âœ… ÙØ§ÛŒÙ„ Ù„Ø§Ú¯ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯"
            echo "ğŸ“ Ø¢Ø®Ø±ÛŒÙ† Ø®Ø·ÙˆØ· Ù„Ø§Ú¯:"
            tail -30 logs/ss_tester.log
          else
            echo "âŒ ÙØ§ÛŒÙ„ Ù„Ø§Ú¯ ÛŒØ§ÙØª Ù†Ø´Ø¯"
          fi
      
      - name: ğŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: shadowsocks-tester-manual-${{ github.run_number }}
          path: |
            trustlink/trustlink_ss.txt
            trustlink/.trustlink_ss_metadata.json
            trustlink/trustlink_ss_backup.txt
            logs/ss_tester.log
            logs/ss_runner.log
          retention-days: 90
      
      - name: ğŸ“ Commit and push results
        run: |
          echo "ğŸ“ Ø«Ø¨Øª Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù†ØªØ§ÛŒØ¬..."
          
          # ØªÙ†Ø¸ÛŒÙ… Git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
          git add trustlink/trustlink_ss.txt || echo "âš ï¸ ÙØ§ÛŒÙ„ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯"
          git add trustlink/.trustlink_ss_metadata.json || echo "âš ï¸ ÙØ§ÛŒÙ„ Ù…ØªØ§Ø¯ÛŒØªØ§ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯"
          git add trustlink/trustlink_ss_backup.txt || echo "âš ï¸ ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯"
          git add logs/ss_tester.log || echo "âš ï¸ ÙØ§ÛŒÙ„ Ù„Ø§Ú¯ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯"
          
          # Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ±Ø§Øª
          if git diff --staged --quiet; then
            echo "â„¹ï¸ Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"
          else
            echo "ğŸ’¾ Ø«Ø¨Øª ØªØºÛŒÛŒØ±Ø§Øª..."
            git commit -m "ğŸ”— Manual Shadowsocks Test - Run #${{ github.run_number }}
            
            ğŸ“Š Test Parameters:
            - Mode: ${{ github.event.inputs.test_mode }}
            - Max Configs: ${{ github.event.inputs.max_configs }}
            - Batch Size: ${{ github.event.inputs.batch_size }}
            - Force Update: ${{ github.event.inputs.force_update }}
            - Test Protocols: ${{ github.event.inputs.test_specific_protocols }}
            - Log Level: ${{ github.event.inputs.log_level }}
            
            ğŸ“ Output Files:
            - Configs: trustlink/trustlink_ss.txt
            - Metadata: trustlink/.trustlink_ss_metadata.json
            - Backup: trustlink/trustlink_ss_backup.txt
            - Logs: logs/ss_tester.log
            
            ğŸš€ Triggered by: Manual execution
            ğŸ‘¤ User: ${{ github.actor }}
            â° Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
            ğŸ”¢ Run ID: ${{ github.run_number }}"
            
            echo "ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª..."
            git push
          fi
      
      - name: ğŸ“ˆ Final summary
        run: |
          echo "ğŸ‰ ØªØ³Øª Ø¯Ø³ØªÛŒ Shadowsocks ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯!"
          echo "ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ù†Ù‡Ø§ÛŒÛŒ:"
          echo "  ğŸ”— Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ ØªØ³Øª Ø´Ø¯Ù‡: $(find configs/raw/ -name '*.txt' -exec wc -l {} + | tail -1 | awk '{print $1}' || echo 'Ù†Ø§Ù…Ø´Ø®Øµ')"
          echo "  âœ… Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ù„Ù…: $(wc -l < trustlink/trustlink_ss.txt 2>/dev/null || echo '0')"
          echo "  ğŸ“ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ: trustlink/trustlink_ss.txt"
          echo "  ğŸ“Š Ù…ØªØ§Ø¯ÛŒØªØ§: trustlink/.trustlink_ss_metadata.json"
          echo "  ğŸ“ Ù„Ø§Ú¯â€ŒÙ‡Ø§: logs/ss_tester.log"
          echo "  ğŸ¯ Artifact: shadowsocks-tester-manual-${{ github.run_number }}"
          echo "  ğŸš€ Triggered by: ${{ github.actor }}"
          echo "  â° Run ID: ${{ github.run_number }}"
