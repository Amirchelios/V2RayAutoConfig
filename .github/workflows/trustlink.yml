name: ğŸ”— TrustLink Auto Update

on:
  schedule:
    # Ù‡Ø± Ø³Ø§Ø¹Øª
    - cron: "0 * * * *"
    # Ù‡Ø± Ù†ÛŒÙ… Ø³Ø§Ø¹Øª (Ø¨Ø±Ø§ÛŒ ØªØ³Øª)
    - cron: "*/30 * * * *"
  workflow_dispatch: {}  # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ
  push:
    paths:
      - 'Files/trustlink.py'
      - '.github/workflows/trustlink.yml'

concurrency:
  group: trustlink-update
  cancel-in-progress: true

jobs:
  update-trustlink:
    runs-on: ubuntu-latest
    name: "Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± TrustLink"
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp

      - name: ğŸ” Check TrustLink Script
        run: |
          if [ ! -f "Files/trustlink.py" ]; then
            echo "âŒ ÙØ§ÛŒÙ„ trustlink.py Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!"
            exit 1
          fi
          echo "âœ… ÙØ§ÛŒÙ„ trustlink.py Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª"
          python -c "import asyncio, aiohttp; print('âœ… ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ OK')"

      - name: ğŸš€ Run TrustLink Update
        run: |
          echo "ğŸ• Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹: $(date)"
          echo "ğŸ“ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ ÙØ¹Ù„ÛŒ: $(pwd)"
          
          # Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙˆØ¬ÙˆØ¯ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
          mkdir -p trustlink logs
          echo "âœ… Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ trustlink Ùˆ logs Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù†Ø¯"
          
          # Ø§Ø¬Ø±Ø§ÛŒ TrustLink
          python Files/trustlink.py
          
          echo "ğŸ• Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù†: $(date)"

      - name: ğŸ“Š Check Results
        run: |
          echo "ğŸ“‹ Ø¨Ø±Ø±Ø³ÛŒ Ù†ØªØ§ÛŒØ¬:"
          
          if [ -f "trustlink/trustlink.txt" ]; then
            echo "âœ… ÙØ§ÛŒÙ„ trustlink.txt Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯"
            echo "ğŸ“ Ø§Ù†Ø¯Ø§Ø²Ù‡ ÙØ§ÛŒÙ„: $(ls -lh trustlink/trustlink.txt | awk '{print $5}')"
            echo "ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ø®Ø·ÙˆØ·: $(wc -l < trustlink/trustlink.txt)"
          else
            echo "âŒ ÙØ§ÛŒÙ„ trustlink.txt Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯!"
            exit 1
          fi
          
          if [ -f "trustlink/.trustlink_metadata.json" ]; then
            echo "âœ… ÙØ§ÛŒÙ„ Ù…ØªØ§Ø¯ÛŒØªØ§ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯"
            echo "ğŸ“„ Ù…Ø­ØªÙˆØ§ÛŒ Ù…ØªØ§Ø¯ÛŒØªØ§:"
            cat trustlink/.trustlink_metadata.json | python -m json.tool
          else
            echo "âš ï¸ ÙØ§ÛŒÙ„ Ù…ØªØ§Ø¯ÛŒØªØ§ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯"
          fi

      - name: ğŸ”„ Commit & Push Changes
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          echo "ğŸ”„ Ø´Ø±ÙˆØ¹ commit Ùˆ push..."
          
          # ØªÙ†Ø¸ÛŒÙ… git
          git config --global user.name "$GIT_AUTHOR_NAME"
          git config --global user.email "$GIT_AUTHOR_EMAIL"
          
          # Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ±Ø§Øª
          git status
          git diff
          
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡ (ÙÙ‚Ø· ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯)
          if [ -f "trustlink/trustlink.txt" ]; then
            git add trustlink/trustlink.txt
            echo "âœ… ÙØ§ÛŒÙ„ trustlink.txt Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯"
          else
            echo "âŒ ÙØ§ÛŒÙ„ trustlink.txt ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!"
            exit 1
          fi
          
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ Ù…ØªØ§Ø¯ÛŒØªØ§ ÙÙ‚Ø· Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
          if [ -f "trustlink/.trustlink_metadata.json" ]; then
            git add trustlink/.trustlink_metadata.json
            echo "âœ… ÙØ§ÛŒÙ„ Ù…ØªØ§Ø¯ÛŒØªØ§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯"
          else
            echo "â„¹ï¸ ÙØ§ÛŒÙ„ Ù…ØªØ§Ø¯ÛŒØªØ§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ - Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯"
          fi
          
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ log ÙÙ‚Ø· Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
          if [ -f "logs/trustlink.log" ]; then
            git add logs/trustlink.log
            echo "âœ… ÙØ§ÛŒÙ„ log Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯"
          else
            echo "â„¹ï¸ ÙØ§ÛŒÙ„ log ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ - Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯"
          fi
          
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ backup ÙÙ‚Ø· Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
          if [ -f "trustlink/trustlink_backup.txt" ]; then
            git add trustlink/trustlink_backup.txt
            echo "âœ… ÙØ§ÛŒÙ„ backup Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯"
          else
            echo "âš ï¸ ÙØ§ÛŒÙ„ backup ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ - Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ø®Ø§Ù„ÛŒ"
            mkdir -p trustlink
            echo "# ÙØ§ÛŒÙ„ backup Ø®Ø§Ù„ÛŒ - Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· workflow" > trustlink/trustlink_backup.txt
            git add trustlink/trustlink_backup.txt
            echo "âœ… ÙØ§ÛŒÙ„ backup Ø®Ø§Ù„ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯"
          fi
          
          # Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ±Ø§Øª staged
          if git diff --cached --quiet; then
            echo "â„¹ï¸ Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø¨Ø±Ø§ÛŒ commit ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"
            exit 0
          fi
          
          # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ
          if [ ! -f "trustlink/trustlink.txt" ]; then
            echo "âŒ ÙØ§ÛŒÙ„ trustlink.txt Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯!"
            exit 1
          fi
          
          # pull --rebase Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ø§Ù†ÙÙ„ÛŒÚ©Øª
          echo "ğŸ“¥ Ø§Ù†Ø¬Ø§Ù… pull --rebase..."
          git pull --rebase origin "$BRANCH_NAME" || {
            echo "âš ï¸ pull --rebase Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ØŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø§ merge"
            git pull origin "$BRANCH_NAME" || true
          }
          
          # commit
          echo "ğŸ’¾ Ø§Ù†Ø¬Ø§Ù… commit..."
          if ! git commit -m "ğŸ”— chore: Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± TrustLink - $(date '+%Y-%m-%d %H:%M:%S')"; then
            echo "âŒ Ø®Ø·Ø§ Ø¯Ø± commit"
            exit 1
          fi
          
          # push
          echo "ğŸš€ Ø§Ù†Ø¬Ø§Ù… push..."
          if ! git push origin HEAD:"$BRANCH_NAME"; then
            echo "âŒ Ø®Ø·Ø§ Ø¯Ø± push"
            exit 1
          fi
          
          echo "âœ… commit Ùˆ push Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯"

      - name: ğŸ“ˆ Final Status
        run: |
          echo "ğŸ‰ TrustLink Update Completed Successfully!"
          echo "ğŸ“… Ø²Ù…Ø§Ù†: $(date)"
          echo "ğŸ·ï¸ Run ID: ${{ github.run_id }}"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          
          if [ -f "trustlink/trustlink.txt" ]; then
            echo "ğŸ“Š Ø¢Ù…Ø§Ø± Ù†Ù‡Ø§ÛŒÛŒ:"
            echo "  ğŸ“ ÙØ§ÛŒÙ„: trustlink/trustlink.txt"
            echo "  ğŸ“ Ø§Ù†Ø¯Ø§Ø²Ù‡: $(ls -lh trustlink/trustlink.txt | awk '{print $5}')"
            echo "  ğŸ“Š Ø®Ø·ÙˆØ·: $(wc -l < trustlink/trustlink.txt)"
            echo "  ğŸ• Ø¢Ø®Ø±ÛŒÙ† ØªØºÛŒÛŒØ±: $(stat -c %y trustlink/trustlink.txt)"
          fi
