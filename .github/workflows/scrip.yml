name: V2Ray Auto Config

on:
  workflow_dispatch:
  # schedule:
  #   - cron: "0 * * * *"  # Ù‡Ø± Ø³Ø§Ø¹Øª Ø¯Ø± Ø¯Ù‚ÛŒÙ‚Ù‡ 0 - ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯Ù‡

permissions:
  contents: write

concurrency:
  group: v2ray-autoconfig-${{ github.ref }}
  cancel-in-progress: false

jobs:
  scrape-and-commit:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # timeout Ø¨Ø±Ø§ÛŒ job Ø§ØµÙ„ÛŒ
    outputs:
      completion_time: ${{ steps.completion.outputs.time }}
      status: ${{ job.status }}

    steps:
      - name: ğŸ“¥ Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ø¯Ø±ÛŒØ§ÙØª Ú©Ù„ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø®Ø²Ù†

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: âš™ï¸ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r Files/requirements.txt

      - name: ğŸ“‚ Check input files
        run: |
          echo "Checking urls.txt:"
          cat Files/urls.txt || echo "urls.txt not found"
          echo "Checking key.json:"
          cat Files/key.json || echo "key.json not found"

      - name: ğŸ•¸ï¸ Run scraping script
        timeout-minutes: 8  # timeout Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø§ØµÙ„ÛŒ
        run: |
          python Files/scrip.py || { echo "Scraper failed, but continuing..."; exit 0; }  # Ø§Ø¯Ø§Ù…Ù‡ Ø­ØªÛŒ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§

      - name: ğŸ“‚ Check directory contents
        run: |
          echo "Listing repository contents:"
          ls -R
          echo "Checking for configs:"
          ls -la configs/ || echo "configs does not exist or is empty"
          echo "Checking for README.md:"
          ls -la README.md || echo "README.md does not exist"

      - name: ğŸ› ï¸ Create configs if not exists
        run: |
          mkdir -p configs
          touch configs/.gitkeep
          echo "Created configs/.gitkeep"

      - name: ğŸ”§ Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: â¬†ï¸ Commit and Push Changes
        timeout-minutes: 5  # timeout Ø¨Ø±Ø§ÛŒ git operations
        run: |
          git fetch origin
          git add -A
          if git diff --cached --quiet; then
            echo "No changes detected. Skipping commit."
          else
            echo "Changes detected. Committing..."
            git commit -m "docs: Update README and config files ğŸ¤– [skip ci]"
            echo "Pulling remote changes with rebase..."
            git pull --rebase --autostash origin main || { echo "Rebase failed, aborting..."; git rebase --abort; exit 0; }
            echo "Pushing changes..."
            git push origin main || { echo "Push failed, but continuing..."; exit 0; }
          fi

      - name: ğŸ• Set completion time
        id: completion
        run: echo "time=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

  # TrustLink workflow Ú©Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² Ø§ØªÙ…Ø§Ù… V2Ray AutoConfig Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯
  trustlink-update:
    runs-on: ubuntu-latest
    needs: scrape-and-commit
    if: always()  # Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯ØŒ Ø­ØªÛŒ Ø§Ú¯Ø± job Ù‚Ø¨Ù„ÛŒ fail Ø´ÙˆØ¯
    timeout-minutes: 5  # timeout Ø¨Ø±Ø§ÛŒ TrustLink
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp

      - name: ğŸ” Check TrustLink Script
        run: |
          if [ ! -f "Files/trustlink.py" ]; then
            echo "âŒ ÙØ§ÛŒÙ„ trustlink.py Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!"
            exit 1
          fi
          echo "âœ… ÙØ§ÛŒÙ„ trustlink.py Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª"
          python -c "import asyncio, aiohttp; print('âœ… ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ OK')"

      - name: ğŸš€ Run TrustLink Update
        timeout-minutes: 3  # timeout Ø¨Ø±Ø§ÛŒ TrustLink script
        run: |
          echo "ğŸ• Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹: $(date)"
          echo "ğŸ“ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ ÙØ¹Ù„ÛŒ: $(pwd)"
          echo "ğŸ“Š ÙˆØ¶Ø¹ÛŒØª job Ù‚Ø¨Ù„ÛŒ: ${{ needs.scrape-and-commit.outputs.status }}"
          
          # Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙˆØ¬ÙˆØ¯ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
          mkdir -p trustlink logs
          echo "âœ… Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ trustlink Ùˆ logs Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù†Ø¯"
          
          # Ø§Ø¬Ø±Ø§ÛŒ TrustLink
          python Files/trustlink.py || { echo "TrustLink failed, but continuing..."; exit 0; }
          
          echo "ğŸ• Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù†: $(date)"

      - name: ğŸ“Š Check Results
        run: |
          echo "ğŸ“‹ Ø¨Ø±Ø±Ø³ÛŒ Ù†ØªØ§ÛŒØ¬:"
          
          if [ -f "trustlink/trustlink.txt" ]; then
            echo "âœ… ÙØ§ÛŒÙ„ trustlink.txt Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯"
            echo "ğŸ“ Ø§Ù†Ø¯Ø§Ø²Ù‡ ÙØ§ÛŒÙ„: $(ls -lh trustlink/trustlink.txt | awk '{print $5}')"
            echo "ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ø®Ø·ÙˆØ·: $(wc -l < trustlink/trustlink.txt)"
          else
            echo "âŒ ÙØ§ÛŒÙ„ trustlink.txt Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯!"
            exit 1
          fi
          
          if [ -f "trustlink/.trustlink_metadata.json" ]; then
            echo "âœ… ÙØ§ÛŒÙ„ Ù…ØªØ§Ø¯ÛŒØªØ§ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯"
            echo "ğŸ“„ Ù…Ø­ØªÙˆØ§ÛŒ Ù…ØªØ§Ø¯ÛŒØªØ§:"
            cat trustlink/.trustlink_metadata.json | python -m json.tool
          else
            echo "âš ï¸ ÙØ§ÛŒÙ„ Ù…ØªØ§Ø¯ÛŒØªØ§ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯"
          fi

      - name: ğŸ”„ Commit & Push TrustLink Changes
        timeout-minutes: 3  # timeout Ø¨Ø±Ø§ÛŒ git operations
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          echo "ğŸ”„ Ø´Ø±ÙˆØ¹ commit Ùˆ push..."
          
          # ØªÙ†Ø¸ÛŒÙ… git
          git config --global user.name "$GIT_AUTHOR_NAME"
          git config --global user.email "$GIT_AUTHOR_EMAIL"
          
          # Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ±Ø§Øª
          git status
          git diff
          
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡ (ÙÙ‚Ø· ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯)
          if [ -f "trustlink/trustlink.txt" ]; then
            git add trustlink/trustlink.txt
            echo "âœ… ÙØ§ÛŒÙ„ trustlink.txt Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯"
          else
            echo "âŒ ÙØ§ÛŒÙ„ trustlink.txt ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!"
            exit 1
          fi
          
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ Ù…ØªØ§Ø¯ÛŒØªØ§ ÙÙ‚Ø· Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
          if [ -f "trustlink/.trustlink_metadata.json" ]; then
            git add trustlink/.trustlink_metadata.json
            echo "âœ… ÙØ§ÛŒÙ„ Ù…ØªØ§Ø¯ÛŒØªØ§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯"
          else
            echo "â„¹ï¸ ÙØ§ÛŒÙ„ Ù…ØªØ§Ø¯ÛŒØªØ§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ - Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯"
          fi
          
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ log ÙÙ‚Ø· Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
          if [ -f "logs/trustlink.log" ]; then
            git add logs/trustlink.log
            echo "âœ… ÙØ§ÛŒÙ„ log Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯"
          else
            echo "â„¹ï¸ ÙØ§ÛŒÙ„ log ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ - Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯"
          fi
          
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ backup ÙÙ‚Ø· Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
          if [ -f "trustlink/trustlink_backup.txt" ]; then
            git add trustlink/trustlink_backup.txt
            echo "âœ… ÙØ§ÛŒÙ„ backup Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯"
          else
            echo "âš ï¸ ÙØ§ÛŒÙ„ backup ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ - Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ø®Ø§Ù„ÛŒ"
            mkdir -p trustlink
            echo "# ÙØ§ÛŒÙ„ backup Ø®Ø§Ù„ÛŒ - Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· workflow" > trustlink/trustlink_backup.txt
            git add trustlink/trustlink_backup.txt
            echo "âœ… ÙØ§ÛŒÙ„ backup Ø®Ø§Ù„ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯"
          fi
          
          # Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ±Ø§Øª staged
          if git diff --cached --quiet; then
            echo "â„¹ï¸ Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø¨Ø±Ø§ÛŒ commit ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"
            exit 0
          fi
          
          # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ
          if [ ! -f "trustlink/trustlink.txt" ]; then
            echo "âŒ ÙØ§ÛŒÙ„ trustlink.txt Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯!"
            exit 1
          fi
          
          # pull --rebase Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ø§Ù†ÙÙ„ÛŒÚ©Øª
          echo "ğŸ“¥ Ø§Ù†Ø¬Ø§Ù… pull --rebase..."
          git pull --rebase origin "$BRANCH_NAME" || {
            echo "âš ï¸ pull --rebase Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ØŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø§ merge"
            git pull origin "$BRANCH_NAME" || true
          }
          
          # commit
          echo "ğŸ’¾ Ø§Ù†Ø¬Ø§Ù… commit..."
          if ! git commit -m "ğŸ”— chore: Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± TrustLink - $(date '+%Y-%m-%d %H:%M:%S')"; then
            echo "âŒ Ø®Ø·Ø§ Ø¯Ø± commit"
            exit 1
          fi
          
          # push
          echo "ğŸš€ Ø§Ù†Ø¬Ø§Ù… push..."
          if ! git push origin HEAD:"$BRANCH_NAME"; then
            echo "âŒ Ø®Ø·Ø§ Ø¯Ø± push"
            exit 1
          fi
          
          echo "âœ… commit Ùˆ push Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯"

      - name: ğŸ“ˆ Final Status
        run: |
          echo "ğŸ‰ TrustLink Update Completed Successfully!"
          echo "ğŸ“… Ø²Ù…Ø§Ù†: $(date)"
          echo "ğŸ·ï¸ Run ID: ${{ github.run_id }}"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸ“Š ÙˆØ¶Ø¹ÛŒØª job Ù‚Ø¨Ù„ÛŒ: ${{ needs.scrape-and-commit.outputs.status }}"
          
          if [ -f "trustlink/trustlink.txt" ]; then
            echo "ğŸ“Š Ø¢Ù…Ø§Ø± Ù†Ù‡Ø§ÛŒÛŒ:"
            echo "  ğŸ“ ÙØ§ÛŒÙ„: trustlink/trustlink.txt"
            echo "  ğŸ“ Ø§Ù†Ø¯Ø§Ø²Ù‡: $(ls -lh trustlink/trustlink.txt | awk '{print $5}')"
            echo "  ğŸ“Š Ø®Ø·ÙˆØ·: $(wc -l < trustlink/trustlink.txt)"
            echo "  ğŸ• Ø¢Ø®Ø±ÛŒÙ† ØªØºÛŒÛŒØ±: $(stat -c %y trustlink/trustlink.txt)"
          fi
