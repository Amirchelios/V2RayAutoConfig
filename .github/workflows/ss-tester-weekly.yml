name: ğŸ”— Shadowsocks Tester - Weekly Execution

on:
  # Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ø± Ù‡ÙØªÙ‡ (ÛŒÚ©Ø´Ù†Ø¨Ù‡ Ø³Ø§Ø¹Øª 2 ØµØ¨Ø­)
  schedule:
    - cron: '0 2 * * 0'
  
  # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Ø­Ø§Ù„Øª ØªØ³Øª'
        required: true
        default: 'single'
        type: choice
        options:
          - single
          - auto
      max_configs:
        description: 'Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ ØªØ³Øª Ø´Ø¯Ù‡'
        required: false
        default: '10000'
        type: string
      batch_size:
        description: 'Ø§Ù†Ø¯Ø§Ø²Ù‡ batch Ø¨Ø±Ø§ÛŒ ØªØ³Øª'
        required: false
        default: '50'
        type: string

env:
  PYTHON_VERSION: '3.9'
  WORKING_DIRECTORY: './'

jobs:
  test-shadowsocks:
    name: ğŸ§ª ØªØ³Øª Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Shadowsocks
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“‹ Display Python version
        run: |
          python --version
          pip --version
      
      - name: ğŸ”§ Install dependencies
        run: |
          cd ss
          pip install -r requirements.txt
          pip list
      
      - name: ğŸ“ Check environment
        run: |
          echo "ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­ÛŒØ· Ø§Ø¬Ø±Ø§..."
          echo "ğŸ“ Ù…Ø³ÛŒØ± ÙØ¹Ù„ÛŒ: $(pwd)"
          echo "ğŸ“ Ù…Ø­ØªÙˆÛŒØ§Øª Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ ss:"
          ls -la ss/
          echo "ğŸ“ Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Xray:"
          ls -la Files/xray-bin/ || echo "âŒ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ Files/xray-bin ÛŒØ§ÙØª Ù†Ø´Ø¯"
          echo "ğŸ“ Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ø¨Ø¹:"
          ls -la configs/raw/ || echo "âŒ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ configs/raw ÛŒØ§ÙØª Ù†Ø´Ø¯"
      
      - name: ğŸš€ Run Shadowsocks Tester
        run: |
          cd ss
          echo "ğŸš€ Ø´Ø±ÙˆØ¹ ØªØ³Øª Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Shadowsocks..."
          echo "ğŸ“Š Ø­Ø§Ù„Øª: ${{ github.event.inputs.test_mode || 'single' }}"
          echo "ğŸ”¢ Ø­Ø¯Ø§Ú©Ø«Ø± Ú©Ø§Ù†ÙÛŒÚ¯: ${{ github.event.inputs.max_configs || '10000' }}"
          echo "ğŸ“¦ Ø§Ù†Ø¯Ø§Ø²Ù‡ batch: ${{ github.event.inputs.batch_size || '50' }}"
          
          # Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª
          python ss_tester.py
          
          echo "âœ… ØªØ³Øª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯"
      
      - name: ğŸ“Š Check results
        run: |
          echo "ğŸ“Š Ø¨Ø±Ø±Ø³ÛŒ Ù†ØªØ§ÛŒØ¬ ØªØ³Øª..."
          
          # Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ
          if [ -f "trustlink/trustlink_ss.txt" ]; then
            echo "âœ… ÙØ§ÛŒÙ„ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ù„Ù… Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯"
            echo "ğŸ“ Ø§Ù†Ø¯Ø§Ø²Ù‡ ÙØ§ÛŒÙ„: $(wc -l < trustlink/trustlink_ss.txt) Ø®Ø·"
          else
            echo "âŒ ÙØ§ÛŒÙ„ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ù„Ù… ÛŒØ§ÙØª Ù†Ø´Ø¯"
          fi
          
          if [ -f "trustlink/.trustlink_ss_metadata.json" ]; then
            echo "âœ… ÙØ§ÛŒÙ„ Ù…ØªØ§Ø¯ÛŒØªØ§ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯"
            echo "ğŸ“Š Ù…Ø­ØªÙˆÛŒØ§Øª Ù…ØªØ§Ø¯ÛŒØªØ§:"
            cat trustlink/.trustlink_ss_metadata.json | python -m json.tool
          else
            echo "âŒ ÙØ§ÛŒÙ„ Ù…ØªØ§Ø¯ÛŒØªØ§ ÛŒØ§ÙØª Ù†Ø´Ø¯"
          fi
          
          if [ -f "logs/ss_tester.log" ]; then
            echo "âœ… ÙØ§ÛŒÙ„ Ù„Ø§Ú¯ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯"
            echo "ğŸ“ Ø¢Ø®Ø±ÛŒÙ† Ø®Ø·ÙˆØ· Ù„Ø§Ú¯:"
            tail -20 logs/ss_tester.log
          else
            echo "âŒ ÙØ§ÛŒÙ„ Ù„Ø§Ú¯ ÛŒØ§ÙØª Ù†Ø´Ø¯"
          fi
      
      - name: ğŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: shadowsocks-tester-results-${{ github.run_number }}
          path: |
            trustlink/trustlink_ss.txt
            trustlink/.trustlink_ss_metadata.json
            trustlink/trustlink_ss_backup.txt
            logs/ss_tester.log
            logs/ss_runner.log
          retention-days: 30
      
      - name: ğŸ“ Commit and push results
        run: |
          echo "ğŸ“ Ø«Ø¨Øª Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù†ØªØ§ÛŒØ¬..."
          
          # ØªÙ†Ø¸ÛŒÙ… Git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
          git add trustlink/trustlink_ss.txt || echo "âš ï¸ ÙØ§ÛŒÙ„ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯"
          git add trustlink/.trustlink_ss_metadata.json || echo "âš ï¸ ÙØ§ÛŒÙ„ Ù…ØªØ§Ø¯ÛŒØªØ§ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯"
          git add trustlink/trustlink_ss_backup.txt || echo "âš ï¸ ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯"
          git add logs/ss_tester.log || echo "âš ï¸ ÙØ§ÛŒÙ„ Ù„Ø§Ú¯ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯"
          
          # Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ±Ø§Øª
          if git diff --staged --quiet; then
            echo "â„¹ï¸ Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"
          else
            echo "ğŸ’¾ Ø«Ø¨Øª ØªØºÛŒÛŒØ±Ø§Øª..."
            git commit -m "ğŸ”— Update Shadowsocks configurations - Run #${{ github.run_number }}
            
            ğŸ“Š Test Results:
            - Source: configs/raw/ShadowSocks.txt
            - Output: trustlink/trustlink_ss.txt
            - Metadata: trustlink/.trustlink_ss_metadata.json
            - Backup: trustlink/trustlink_ss_backup.txt
            - Logs: logs/ss_tester.log
            
            ğŸš€ Triggered by: ${{ github.event_name }}
            â° Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
            ğŸ”¢ Run ID: ${{ github.run_number }}"
            
            echo "ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª..."
            git push
          fi
      
      - name: ğŸ“ˆ Summary
        run: |
          echo "ğŸ‰ ØªØ³Øª Shadowsocks ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯!"
          echo "ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ù†ØªØ§ÛŒØ¬:"
          echo "  ğŸ”— Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ ØªØ³Øª Ø´Ø¯Ù‡: $(find configs/raw/ -name '*.txt' -exec wc -l {} + | tail -1 | awk '{print $1}' || echo 'Ù†Ø§Ù…Ø´Ø®Øµ')"
          echo "  âœ… Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ù„Ù…: $(wc -l < trustlink/trustlink_ss.txt 2>/dev/null || echo '0')"
          echo "  ğŸ“ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ: trustlink/trustlink_ss.txt"
          echo "  ğŸ“Š Ù…ØªØ§Ø¯ÛŒØªØ§: trustlink/.trustlink_ss_metadata.json"
          echo "  ğŸ“ Ù„Ø§Ú¯â€ŒÙ‡Ø§: logs/ss_tester.log"
          echo "  ğŸ¯ Artifact: shadowsocks-tester-results-${{ github.run_number }}"
